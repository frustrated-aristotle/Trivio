@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}
@section Scripts{
    <script>
        let selectedRole= null;
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/gameHub")
            .build();
        
        const roleButton = document.querySelector('.dropdown-toggle');
		const startButton = document.querySelector('#startGameBtn');

        function validateAndJoin(isStartGame, roomCode = null) {
            const username = isStartGame ? 
                document.getElementById('startUsername').value : 
                document.getElementById('attendUsername').value;
            
            if (!username.trim()) {
                alert('Please enter a username');
                return;
            }

            if (!selectedRole) {
                alert('Please select a role');
                return;
            }

            connection.start()
                .then(() => {
                    if (isStartGame) {
                        // Create room on server, then redirect; join will happen on GamePage
                        const code = Math.floor(Math.random() * 99999 + 10000);
                        return connection.invoke('CreateRoom', code, selectedRole, username)
                            .then(() => code);
                    } else {
                        // Attending existing room: just redirect; join will happen on GamePage
                        return roomCode;
                    }
                })
                .then((code) => {
                    try {
                        sessionStorage.setItem('trivio_username', username);
                        sessionStorage.setItem('trivio_role', selectedRole);
                    } catch (e) { }
                    window.location.href = `/GamePage/${code}`;
                })
                .catch(err => {
                    // Validation failed - show error
                    alert(err.message || 'Failed to join room');
                    connection.stop();
                });
        }
        function setRole(role) {
            selectedRole = role;

            // Update button label
            if (role === 'player') {
                roleButton.textContent = 'Player';
            } else if (role === 'spectator') {
                roleButton.textContent = 'Spectator';
            }

            // Keep hidden inputs in sync for POST handlers
            const hiddenStartRole = document.getElementById('hiddenRole');
            if (hiddenStartRole) hiddenStartRole.value = selectedRole;
            const hiddenAttendRole = document.getElementById('hiddenAttendRole');
            if (hiddenAttendRole) hiddenAttendRole.value = selectedRole;
        }


        function startTheGame(isAdmin)
        {
           document.getElementById('hiddenIsAdmin').value = !!isAdmin;
           if (!document.getElementById('hiddenRole').value) {
               document.getElementById('hiddenRole').value = selectedRole ?? 'player';
           }
           document.getElementById('startForm').submit();
        }

        function attendTheGame()
        {
           const roomCode = document.getElementById('roomCode').value;
           if (!roomCode.trim()) {
               alert('Please enter a room code');
               return;
           }
           document.getElementById('hiddenAttendCode').value = parseInt(roomCode);
           if (!document.getElementById('hiddenAttendRole').value) {
               document.getElementById('hiddenAttendRole').value = selectedRole ?? 'spectator';
           }
           document.getElementById('attendForm').submit();
        }
    </script>
}

<div class="text-center">
    <h1 class="display-4">Trivio</h1>
    <p>Have fun with your friends. Hit play, select your nickname and share your game code with your friends.</p>
    <p>To play, select Player. If you want only spectating, select Spectator.</p>
    <button class="btn btn-primary" data-bs-toggle='modal' data-bs-target='#startModal'>Play</button>
    <button class="btn btn-primary" data-bs-toggle='modal' data-bs-target='#attendModal'>Attend A Game</button>

</div>

<!-- Start Modal -->
<div class='modal fade' id='startModal' tabindex='-1' aria-labelledby='startModalLabel' aria-hidden='true'>
    <div class='modal-dialog'>
        <div class='modal-content'>
        <div class='modal-header'>
            <h5 class='modal-title' id='startModalLabel'>Start Game</h5>
            <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
        </div>
        <div class='modal-body'>
            <form method='post' asp-page-handler="StartGame" id='startForm'>
                <div class='mb-3'>
                        <div class="mb-3">
                            <label for="username" class="form-label">Enter Your Nickname</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="username" id="startUsername" placeholder="Your nickname">
                                <button type="button" class="btn btn-secondary" id="randomUsernameBtn" data-target="startUsername">
                                    <i class="bi bi-arrow-clockwise"></i> Random Name
                                </button>
                            </div>
                        </div>

                    <label for='role' class='form-label'>Choose Your Role</label>
                    <div class='dropdown'>
                        <button class='btn btn-secondary dropdown-toggle' style="width: 100%;" type='button' data-bs-toggle="dropdown" aria-expanded="false">Select Your Role</button>
                        <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="setRole('player')">Player</a></li>
                                <li><a class="dropdown-item" href="#" onclick="setRole('spectator')">Spectator</a></li>
                        </ul>
                    </div>
                    <input type='hidden' id='hiddenIsAdmin' name='isAdmin' value='true' />
                    <input type='hidden' id='hiddenRole' name='role' value='' />
                </div>
            </form>
        </div>
        <div class='modal-footer'>
            <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Cancel</button>
            <button type='button' class='btn btn-primary' id='startGameBtn' onclick="startTheGame(true)">Start Game</button>
            </div>
        </div>
    </div>
</div>
<!-- Attend Modal -->
<div class="modal fade" id='attendModal' tabindex="-1" aria-labelledby="attendModalLabel" aria-hidden="true">
    <div class='modal-dialog'>
        <div class='modal-content'>
            <div class="modal-header text-center">
                <h5 class="modal-title">Attend A Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss='modal' aria-label='Close'>X</button>
            </div>
            <div class="modal-body">
                <form method='post' asp-page-handler="Attend" id='attendForm'>
                    <label for="roomCode">Room Code</label>
                    <input type="text" class="form-control" id="roomCode" placeholder="Enter your room code here..." />
                    <label for="attendUsername">Your Nickname</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="attendUsername" name="username" placeholder="Enter your nickname code here..." />
                        <button type="button" class="btn btn-secondary" id="randomAttendUsernameBtn" data-target="attendUsername">
                            <i class="bi bi-arrow-clockwise"></i> Random Name
                        </button>
                    </div>
                    <div class='dropdown'>
                        <button class='btn btn-secondary dropdown-toggle' style="width: 100%;" type='button' data-bs-toggle="dropdown" aria-expanded="false">Select Your Role</button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="setRole('player')">Player</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setRole('spectator')">Spectator</a></li>
                        </ul>
                    </div>
                    <input type='hidden' id='hiddenAttendRole' name='role' value='' />
                    <input type='hidden' id='hiddenAttendCode' name='roomCode' value='' />
                </form>
            </div>
            <div class='modal-footer'>
                <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Cancel</button>
                <button type='button' class='btn btn-primary' onclick='attendTheGame()'>Attend</button>
            </div>
        </div>
    </div>
</div>
<script src="~/js/utils.js"></script>
