@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}
@section Scripts{
    <script>
        let selectedRole= null;
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/gameHub")
            .build();
        
        const roleButton = document.querySelector('.dropdown-toggle');
		const startButton = document.querySelector('#startGameBtn');
        
        // Helper function to ensure connection is started
        async function ensureConnection() {
            if (connection.state === signalR.HubConnectionState.Disconnected) {
                await connection.start();
            }
            return Promise.resolve();
        }
        
        // Cleanup on page unload
        window.addEventListener("beforeunload", () => {
            if (connection.state !== signalR.HubConnectionState.Disconnected) {
                connection.stop();
            }
        });
        
        // Lobby update event handlers (placeholder - implement UI updates here)
        // Helper function to format time ago
        function formatTimeAgo(dateString) {
            if (!dateString) return "Just now";
            
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return "Just now";
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        }
        
        // Helper function to create a room card element
        function createRoomCard(roomData) {
            const roomCode = roomData.code || roomData.Code;
            const hostName = roomData.hostName || roomData.HostName || "Unknown";
            const playerCount = roomData.playerCount !== undefined ? roomData.playerCount : (roomData.Connections || 0);
            const capacity = roomData.capacity !== undefined ? roomData.capacity : (roomData.Capacity || 8);
            const isPrivate = roomData.isPrivate !== undefined ? roomData.isPrivate : (roomData.IsPrivate || false);
            const gameStarted = roomData.gameStarted !== undefined ? roomData.gameStarted : (roomData.GameStarted || false);
            const createdAt = roomData.createdAt || roomData.CreatedAt;
            const status = gameStarted ? "In Game" : "Waiting";
            const statusBadgeClass = gameStarted ? "bg-warning text-dark" : "bg-success";
            
            const timeAgo = formatTimeAgo(createdAt);
            
            return `
                <div class="col-12 col-md-6 col-lg-4" data-room-code="${roomCode}">
                    <div class="trivio-room-card card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="card-title mb-1 fw-bold">Room #${roomCode}</h5>
                                    <p class="text-muted small mb-0">
                                        ${isPrivate 
                                            ? '<i class="bi bi-lock-fill text-warning me-1"></i>Private Room'
                                            : `<i class="bi bi-person-circle me-1"></i>Host: ${hostName}`
                                        }
                                    </p>
                                </div>
                                <span class="badge ${statusBadgeClass}">${status}</span>
                            </div>
                            
                            <div class="d-flex align-items-center gap-3 mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-people-fill text-primary me-1"></i>
                                    <span class="small">${playerCount}/${capacity} players</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-clock text-muted me-1"></i>
                                    <span class="small text-muted">${timeAgo}</span>
                                </div>
                            </div>
                            
                            <button class="btn trivio-btn-primary w-100" onclick="joinRoom(${roomCode})">
                                <i class="bi bi-box-arrow-in-right me-1"></i>Join Room
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Function to add or update a room in the UI
        function upsertRoom(roomData) {
            const container = document.getElementById('openRoomsContainer');
            if (!container) return;
            
            const roomCode = roomData.code || roomData.Code;
            const existingRoom = container.querySelector(`[data-room-code="${roomCode}"]`);
            
            if (existingRoom) {
                // Update existing room
                existingRoom.outerHTML = createRoomCard(roomData);
            } else {
                // Add new room
                const emptyState = document.getElementById('emptyRoomsState');
                if (emptyState) emptyState.style.display = 'none';
                
                container.insertAdjacentHTML('beforeend', createRoomCard(roomData));
            }
        }
        
        // Function to remove a room from the UI
        function removeRoom(roomCode) {
            const container = document.getElementById('openRoomsContainer');
            if (!container) return;
            
            const roomElement = container.querySelector(`[data-room-code="${roomCode}"]`);
            if (roomElement) {
                roomElement.remove();
            }
            
            // Show empty state if no rooms
            if (container.children.length === 0) {
                const emptyState = document.getElementById('emptyRoomsState');
                if (emptyState) emptyState.style.display = 'block';
            }
        }
        
        // Function to update room status
        function updateRoomStatus(roomCode, newStatus) {
            const roomElement = document.querySelector(`[data-room-code="${roomCode}"]`);
            if (!roomElement) return;
            
            const badge = roomElement.querySelector('.badge');
            if (badge) {
                badge.textContent = newStatus;
                badge.className = `badge ${newStatus === "In Game" ? "bg-warning text-dark" : "bg-success"}`;
            }
        }
        
        // Function to join a room (pre-fills modal)
        function joinRoom(roomCode) {
            document.getElementById('roomCode').value = roomCode;
            const attendModal = new bootstrap.Modal(document.getElementById('attendModal'));
            attendModal.show();
        }
        
        // Lobby update event handlers
        connection.on("RoomCreated", (roomData) => {
            console.log("Room created:", roomData);
            upsertRoom(roomData);
        });
        
        connection.on("RoomUpdated", (roomData) => {
            console.log("Room updated:", roomData);
            upsertRoom(roomData);
        });
        
        connection.on("RoomClosed", (roomCode) => {
            console.log("Room closed:", roomCode);
            removeRoom(roomCode);
        });
        
        connection.on("RoomStatusChanged", (roomCode, newStatus) => {
            console.log("Room status changed:", roomCode, newStatus);
            updateRoomStatus(roomCode, newStatus);
        });
        
        // Optional: Load initial rooms when connected
        connection.on("InitialRoomsList", (rooms) => {
            console.log("Received initial rooms list:", rooms);
            const container = document.getElementById('openRoomsContainer');
            if (!container) return;
            
            // Clear existing rooms (if any)
            container.innerHTML = '';
            
            if (rooms && rooms.length > 0) {
                const emptyState = document.getElementById('emptyRoomsState');
                if (emptyState) emptyState.style.display = 'none';
                
                rooms.forEach(room => {
                    container.insertAdjacentHTML('beforeend', createRoomCard(room));
                });
            } else {
                const emptyState = document.getElementById('emptyRoomsState');
                if (emptyState) emptyState.style.display = 'block';
            }
        });
        
        function validateAndJoin(isStartGame, roomCode = null) {
            const username = isStartGame ? 
                document.getElementById('startUsername').value : 
                document.getElementById('attendUsername').value;
            
            if (!username.trim()) {
                alert('Please enter a username');
                return;
            }

            if (!selectedRole) {
                alert('Please select a role');
                return;
            }
            
            // Ensure connection is started (might already be connected from page load)
            ensureConnection()
                .then(() => {
                    if (isStartGame) {
                        // Create room on server, then redirect; join will happen on GamePage
                        const code = Math.floor(Math.random() * 99999 + 10000);
                        return connection.invoke('CreateRoom', code, selectedRole, username)
                            .then(() => code);
                    } else {
                        // Attending existing room: just redirect; join will happen on GamePage
                        return roomCode;
                    }
                })
                .then((code) => {
                    try {
                        sessionStorage.setItem('trivio_username', username);
                        sessionStorage.setItem('trivio_role', selectedRole);
                    } catch (e) { }
                    window.location.href = `/GamePage/${code}`;
                })
                .catch(err => {
                    // Validation failed - show error
                    alert(err.message || 'Failed to join room');
                    connection.stop();
                });
        }
        function setRole(role) {
            selectedRole = role;

            // Update button label
            if (role === 'player') {
                roleButton.textContent = 'Player';
            } else if (role === 'spectator') {
                roleButton.textContent = 'Spectator';
            }

            // Keep hidden inputs in sync for POST handlers
            const hiddenStartRole = document.getElementById('hiddenRole');
            if (hiddenStartRole) hiddenStartRole.value = selectedRole;
            const hiddenAttendRole = document.getElementById('hiddenAttendRole');
            if (hiddenAttendRole) hiddenAttendRole.value = selectedRole;
        }


        function startTheGame(isAdmin)
        {
           document.getElementById('hiddenIsAdmin').value = !!isAdmin;
           if (!document.getElementById('hiddenRole').value) {
               document.getElementById('hiddenRole').value = selectedRole ?? 'player';
           }
           // Get private room checkbox state
           const privateRoomCheckbox = document.getElementById('privateRoom');
           const isPrivateRoom = privateRoomCheckbox ? privateRoomCheckbox.checked : false;
           document.getElementById('hiddenPrivateRoom').value = isPrivateRoom;
           
           // Get password if private room is checked
           if (isPrivateRoom) {
               const passwordInput = document.getElementById('roomPassword');
               if (passwordInput && !passwordInput.value.trim()) {
                   alert('Please enter a password for the private room');
                   return;
               }
           }
           
           document.getElementById('startForm').submit();
        }

        // Handle private room checkbox toggle and initialize SignalR connection
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize SignalR connection for lobby
            connection.start()
                .then(() => {
                    console.log("Connected to SignalR");
                    // Join lobby group to receive real-time room updates
                    return connection.invoke("AddUserToLobby");
                })
                .then(() => {
                    console.log("Added to lobby group");
                })
                .catch(err => {
                    console.error("Error connecting to SignalR:", err);
                });
            
            // Handle private room checkbox toggle
            const privateRoomCheckbox = document.getElementById('privateRoom');
            const passwordFieldContainer = document.getElementById('passwordFieldContainer');
            const hiddenPrivateRoom = document.getElementById('hiddenPrivateRoom');
            
            if (privateRoomCheckbox && passwordFieldContainer) {
                privateRoomCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        passwordFieldContainer.style.display = 'block';
                        if (hiddenPrivateRoom) hiddenPrivateRoom.value = 'true';
                    } else {
                        passwordFieldContainer.style.display = 'none';
                        // Clear password field
                        const passwordInput = document.getElementById('roomPassword');
                        if (passwordInput) passwordInput.value = '';
                        if (hiddenPrivateRoom) hiddenPrivateRoom.value = 'false';
                    }
                });
            }
        });

        function attendTheGame()
        {
           const roomCode = document.getElementById('roomCode').value;
           if (!roomCode.trim()) {
               alert('Please enter a room code');
               return;
           }
           document.getElementById('hiddenAttendCode').value = parseInt(roomCode);
           if (!document.getElementById('hiddenAttendRole').value) {
               document.getElementById('hiddenAttendRole').value = selectedRole ?? 'spectator';
           }
           document.getElementById('attendForm').submit();
        }

    </script>
}

<section class="trivio-hero text-center">
    <div class="trivio-hero-content">
        <h1 class="display-4 fw-bold mb-3">Trivio</h1>
        <p class="lead mb-2">Fast-paced, real-time Turkish word game with your friends.</p>
        <p class="mb-4">Create a room, share your code, and see everyone’s moves live with SignalR and Redis.</p>
        <div class="d-flex justify-content-center gap-3 flex-wrap">
            <button class="btn btn-lg trivio-btn-primary" data-bs-toggle='modal' data-bs-target='#startModal'>
                <i class="bi bi-play-fill me-1"></i> Create Room
            </button>
            <button class="btn btn-lg trivio-btn-secondary" data-bs-toggle='modal' data-bs-target='#attendModal'>
                <i class="bi bi-person-plus-fill me-1"></i> Join Room
            </button>
        </div>
        <div class="trivio-hero-hint mt-3">
            <span class="badge bg-light text-dark me-2"><i class="bi bi-people-fill me-1"></i>Players & Spectators</span>
            <span class="badge bg-light text-dark"><i class="bi bi-lightning-charge-fill me-1"></i>Real-time rounds</span>
        </div>
    </div>
</section>

<!-- Open Rooms Section -->
<section class="trivio-open-rooms mb-5">
    <div class="container trivio-main-container">
        <div class="trivio-open-rooms-header mb-4">
            <h2 class="h4 fw-bold mb-2">Open Rooms</h2>
            <p class="text-muted small mb-0">Join an active game room or wait for players to start</p>
        </div>
        
        <div class="row g-3" id="openRoomsContainer">
            <!-- Rooms will be dynamically added here via SignalR -->
        </div>
        
        <!-- Empty State (hidden for now, you can show this when no rooms exist) -->
        <div class="trivio-empty-state text-center py-5" id="emptyRoomsState" style="display: none;">
            <i class="bi bi-door-open display-1 text-muted mb-3"></i>
            <h5 class="fw-bold mb-2">No open rooms at the moment</h5>
            <p class="text-muted mb-4">Be the first to create a room and start playing!</p>
            <button class="btn trivio-btn-primary" data-bs-toggle='modal' data-bs-target='#startModal'>
                <i class="bi bi-plus-circle me-1"></i>Create Room
            </button>
        </div>
    </div>
</section>

<!-- Start Modal -->
<div class='modal fade trivio-modal' id='startModal' tabindex='-1' aria-labelledby='startModalLabel' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content'>
            <div class='modal-header'>
                <div>
                    <h5 class='modal-title' id='startModalLabel'>Create a New Room</h5>
                    <small class="text-muted">Choose your nickname, role, and optionally lock the room with a password.</small>
                </div>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form method='post' asp-page-handler="StartGame" id='startForm'>
                    <div class='mb-3'>
                        <label for="startUsername" class="form-label trivio-modal-label">Your nickname</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="username" id="startUsername" placeholder="e.g. CrazyHawk" />
                            <button type="button" class="btn btn-outline-secondary" id="randomUsernameBtn" data-target="startUsername">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class='form-label trivio-modal-label'>Role</label>
                        <div class='dropdown'>
                            <button class='btn btn-outline-secondary dropdown-toggle w-100' type='button' data-bs-toggle="dropdown" aria-expanded="false">
                                Select your role
                            </button>
                            <ul class="dropdown-menu w-100">
                                <li><a class="dropdown-item" href="#" onclick="setRole('player')">Player</a></li>
                                <li><a class="dropdown-item" href="#" onclick="setRole('spectator')">Spectator</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="mb-3 form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="privateRoom" role="switch" />
                        <label class="form-check-label trivio-modal-label" for="privateRoom">
                            Make room private (require password to join)
                        </label>
                    </div>

                    <div class="mb-3" id="passwordFieldContainer" style="display: none;">
                        <label for="roomPassword" class="form-label trivio-modal-label">Room password</label>
                        <input type="password" class="form-control" id="roomPassword" name="password" placeholder="Enter a password for your room" />
                    </div>

                    <input type='hidden' id='hiddenIsAdmin' name='isAdmin' value='true' />
                    <input type='hidden' id='hiddenPrivateRoom' name='privateRoom' value='false' />
                    <input type='hidden' id='hiddenRole' name='role' value='' />
                </form>
            </div>
            <div class='modal-footer'>
                <button type='button' class='btn btn-outline-secondary' data-bs-dismiss='modal'>Cancel</button>
                <button type='button' class='btn trivio-btn-primary' id='startGameBtn' onclick="startTheGame(true)">Start game</button>
            </div>
        </div>
    </div>
</div>

<!-- Attend Modal -->
<div class="modal fade trivio-modal" id='attendModal' tabindex="-1" aria-labelledby="attendModalLabel" aria-hidden="true">
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content'>
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="attendModalLabel">Join an Existing Room</h5>
                    <small class="text-muted">Enter the room code you received and your nickname.</small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class="modal-body">
                <form method='post' asp-page-handler="Attend" id='attendForm'>
                    <div class="mb-3">
                        <label for="roomCode" class="form-label trivio-modal-label">Room code</label>
                        <input type="text" class="form-control" id="roomCode" placeholder="5-digit room code" />
                    </div>
                    <div class="mb-3">
                        <label for="attendUsername" class="form-label trivio-modal-label">Your nickname</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="attendUsername" name="username" placeholder="e.g. SilentWolf" />
                            <button type="button" class="btn btn-outline-secondary" id="randomAttendUsernameBtn" data-target="attendUsername">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class='form-label trivio-modal-label'>Role</label>
                        <div class='dropdown'>
                            <button class='btn btn-outline-secondary dropdown-toggle w-100' type='button' data-bs-toggle="dropdown" aria-expanded="false">
                                Select your role
                            </button>
                            <ul class="dropdown-menu w-100">
                                <li><a class="dropdown-item" href="#" onclick="setRole('player')">Player</a></li>
                                <li><a class="dropdown-item" href="#" onclick="setRole('spectator')">Spectator</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="attendPassword" class="form-label trivio-modal-label">
                            Room password <span class="text-muted">(only if the room is private)</span>
                        </label>
                        <input type="password" class="form-control" id="attendPassword" name="password" placeholder="Enter room password if needed" />
                    </div>
                    <input type='hidden' id='hiddenAttendRole' name='role' value='' />
                    <input type='hidden' id='hiddenAttendCode' name='roomCode' value='' />
                </form>
            </div>
            <div class='modal-footer'>
                <button type='button' class='btn btn-outline-secondary' data-bs-dismiss='modal'>Cancel</button>
                <button type='button' class='btn trivio-btn-primary' onclick='attendTheGame()'>Join room</button>
            </div>
        </div>
    </div>
</div>
<script src="~/js/utils.js"></script>
